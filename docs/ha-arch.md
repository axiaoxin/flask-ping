title: 高可用架构
date: 2018-07-03
tag: []


```
+----------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                                                                                                                    |
|              +--------------------+                            +--------------------+                         +--------------------+               |
|              |                    |                            |                    |                         |                    |               |
|              | nginx + keepalived |                            | nginx + keepalived |                         | nginx + keepalived |               |
|              |                    |                            |                    |                         |                    |               |
|              +--------------------+                            +--------------------+                         +--------------------+               |
|                                                                                                                                                    |
|                                                                        NGINX                                                                       |
|                                                                                                                                                    |
+-----------+-----------------------------------------------------------------------------------------------------------------------------+----------+
            |                                                                                                                             |
            |                                                                                                                             |
            |                                                                                                                             |
            |                                                                                                                             |
            |                                                                                                                             |
            |                                                                                                                             |
+----------------------------------------------------------------------+        +--------------------------------------------------------------------+
|           |                                                          |        |                                                         |          |
|           |                flask-skeleton                            |        |                           flask-skeleton                |          |
|           |                                                          |        |                                                         |          |
|   +-------v---+  +-----------------------------------------------+   |        |   +---------------------------------------------+  +----v------+   |
|   |           |  |                                               |   |        |   |                                             |  |           |   |
|   |           |  |                   RMQ WORKERS                 |   |        |   |                RMQ WORKERS                  |  |           |   |
|   |           |  |                                               |   |        |   |                                             |  |           |   |
|   |   flask   |  |       +--------+  +--------+  +--------+      |   |        |   |    +--------+  +--------+  +--------+       |  |   flask   |   |
|   |    api    |  |       | celery |  | celery |  | celery |      |   |        |   |    | celery |  | celery |  | celery |       |  |    api    |   |
|   |   server  |  |       | email  |  |  sms   |  | other  |      |   |        |   |    | email  |  |  sms   |  | other  |       |  |   server  |   |
|   |           |  |       | worker |  | worker |  | worker |      |   |        |   |    | worker |  | worker |  | worker |       |  |           |   |
|   |           |  |       +--------+  +--------+  +--------+      |   |        |   |    +--------+  +--------+  +--------+       |  |           |   |
|   |           |  |                                               |   |        |   |                                             |  |           |   |
|   +---------+-+  +----------------+------------^-----------------+   |        |   +----------------^---------------+------------+  +-+---------+   |
|             |                     |            |                     |        |                    |               |                 |             |
+------^--^------------------------------------------------------------+        +----------------------------------------------------------^---^-----+
       |  |   |                     |            |                                                   |               |                 |   |   |
       |  |   |                     |            |                                                   |               |                 |   |   |
       |  |   |                     |            |                                                   |               |                 |   |   |
       |  |   |                     |            |                                                   |               |                 |   |   |
       |  |   |                     |            |                                                   |               |                 |   |   |
       |  |   |                     |            |                                                   |               |                 |   |   |
       |  |   |                     |    +-------+---------------------------------------------------+----------+    |                 |   |   |
       |  |   |                     |    |                                                                      |    |                 |   |   |
       |  |   |                     |    |         +----------+         +----------+        +----------+        |    |                 |   |   |
       |  |   |                     |    |         |          |         |          |        |          |        |    |                 |   |   |
       |  |   +-------------------------->         | rabbitmq +---------+ rabbitmq +--------+ rabbitmq |        <----------------------+   |   |
       |  |                         |    |         |          |         |          |        |          |        |    |                     |   |
       |  |                         |    |         +----------+         +----------+        +----------+        |    |                     |   |
       |  |                         |    |                                                                      |    |                     |   |
       |  |                         |    |                            RabbitMQ Cluster                          |    |                     |   |
       |  |                         |    |                                                                      |    |                     |   |
       |  |                         |    +----------------------------------------------------------------------+    |                     |   |
       |  |                         |                                                                                |                     |   |
       |  |                         |                                                                                |                     |   |
       |  |                         |                                                                                |                     |   |
       |  |                         |                                                                                |                     |   |
       |  |                         |                                                                                |                     |   |
       |  |                    +----v--------------------------------------------------------------------------------v----+                |   |
       |  |                    |                                                                                          |                |   |
       |  |                    |         +----------------+         +----------------+         +----------------+         |                |   |
       |  |                    |         |                |         |                |         |                |         |                |   |
       |  +-------------------->         |  redis-slave   |         |  redis-master  |         |  redis-slave   |         <----------------+   |
       |                       |         | redis-sentinel +---------+ redis-sentinel +---------+ redis-sentinel |         |                    |
       |                       |         |                |         |                |         |                |         |                    |
       |                       |         +----------------+         +----------------+         +----------------+         |                    |
       |                       |                                                                                          |                    |
       |                       |                                          Redis                                           |                    |
       |                       |                                                                                          |                    |
       |                       +------------------------------------------------------------------------------------------+                    |
       |                                                                                                                                       |
       |                                                                                                                                       |
       |                                                                                                                                       |
 +-----v---------------------------------------------------------------------------------------------------------------------------------------v-------+
 |                                                                                                                                                     |
 |                                                                       MySQL                                                                         |
 |                                                                                                                                                     |
 |           +-----------------------------+                                                              +-----------------------------+              |
 |           |                             |                                                              |                             |              |
 |           | mysql-master-1 + keepalived +--------------------------------------------------------------+ mysql-master-2 + keepalived |              |
 |           |                             |                                                              |                             |              |
 |           +-----------------------------+                                                              +-----------------------------+              |
 |                                                                                                                                                     |
 |                                                                                                                                                     |
 +-----------------------------------------------------------------------------------------------------------------------------------------------------+
```
